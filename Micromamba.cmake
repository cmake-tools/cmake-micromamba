set(MICROMAMBA_LATEST_VERSION "0.25.1" CACHE INTERNAL "Micromamba latest version")
set(Micromamba_DIR "${PROJECT_SOURCE_DIR}/cmake" CACHE INTERNAL "")

set(MICROMAMBA_0.25.1_WIN64_SHA256 "ed3b12b747f05a630198d3a8a8f7120bde22ae9033cb62af95d6f3df57fe9b0c" CACHE INTERNAL "Micromamba SHA256")
set(MICROMAMBA_0.25.1_OSX64_SHA256 "bd80ed9cb39748a40ae7dfd124aa18e453bf4793e281daf687710c81272e8be1" CACHE INTERNAL "Micromamba SHA256")
set(MICROMAMBA_0.25.1_OSXARM64_SHA256 "b39fb2f9f2bed41c5ad885f41f49ba751a4ba5ee01ee96ca8293a84aa603d1b2" CACHE INTERNAL "Micromamba SHA256")
set(MICROMAMBA_0.25.1_PPC64LE_SHA256 "0f5be296570c93317ff22af8b586cf07bd4a96c5e30b323b53fa0970755c2c31" CACHE INTERNAL "Micromamba SHA256")
set(MICROMAMBA_0.25.1_AARCH64_SHA256 "069937fc13c42b3963f1bbe991ad921cdcd75f07771b9a6468c92b66d9b298f6" CACHE INTERNAL "Micromamba SHA256")
set(MICROMAMBA_0.25.1_LINUX64_SHA256 "2d8ab91435ea75e4b76412795742b6a17ff25f6d7081a9411a1bc96688e1f7d1" CACHE INTERNAL "Micromamba SHA256")

set(MICROMAMBA_0.25.0_WIN64_SHA256 "8c2b679eeb9bf9d3a7a89f9753e72e96f8bde1734af24c687f51589b02009474" CACHE INTERNAL "Micromamba SHA256")
set(MICROMAMBA_0.25.0_OSX64_SHA256 "8f9aef1988c08ed7d65d2d00c4115bea881c64adcade87e6ea26db9fa8eeff08" CACHE INTERNAL "Micromamba SHA256")
set(MICROMAMBA_0.25.0_OSXARM64_SHA256 "aabfefc4c4902930c67cd50a0c09b368bb27d4c6f0bd293d5068a4a6a7243e13" CACHE INTERNAL "Micromamba SHA256")
set(MICROMAMBA_0.25.0_PPC64LE_SHA256 "ce3329f4b9f9922d1f7bd0137edb0b80755f34d05d2c451726e14194d78609c8" CACHE INTERNAL "Micromamba SHA256")
set(MICROMAMBA_0.25.0_AARCH64_SHA256 "20fc7fa2a6208482afe98494864725f3084cf7a9bd8a581dbf6aa5f1be14a70c" CACHE INTERNAL "Micromamba SHA256")
set(MICROMAMBA_0.25.0_LINUX64_SHA256 "6bafd0ce6570269ae6ec9ae72a401cb21359b34f45b75b2a7a66499821e45322" CACHE INTERNAL "Micromamba SHA256")

set(MICROMAMBA_0.24.0_WIN64_SHA256 "eb53b068eb03065434faeeb7dfccc43a4174c34a1584065a05d70bec34bb10ac" CACHE INTERNAL "Micromamba SHA256")
set(MICROMAMBA_0.24.0_OSX64_SHA256 "3ecf46f18c7f900c0acb7af89f097899161f0f37a8e16bedd8431d065a003902" CACHE INTERNAL "Micromamba SHA256")
set(MICROMAMBA_0.24.0_OSXARM64_SHA256 "e1ceb65f08a700e019ef396b4c4ed6abd98999509269eb09c89128680b78d3cc" CACHE INTERNAL "Micromamba SHA256")
set(MICROMAMBA_0.24.0_PPC64LE_SHA256 "536b358dc2cf52d910498e65338919376c8cd0fcc727b19ca862403fc9a578d1" CACHE INTERNAL "Micromamba SHA256")
set(MICROMAMBA_0.24.0_AARCH64_SHA256 "8ef7056497ef93de885eb4e0d68a8aa348881fb9c09ce9e4d33b8e26bf4014a2" CACHE INTERNAL "Micromamba SHA256")
set(MICROMAMBA_0.24.0_LINUX64_SHA256 "daaef648a0307a4d011dc888df9b02047a8cdf820fb9bcaddba20a29d99cdae9" CACHE INTERNAL "Micromamba SHA256")

set(MICROMAMBA_0.23.0_WIN64_SHA256 "063815c2b494112c09d82f8cf3911be2ec9b72f5e475ad56baec37e80288f019" CACHE INTERNAL "Micromamba SHA256")
set(MICROMAMBA_0.23.0_OSX64_SHA256 "9d374e4693bc409f32c06a1c8a89506994d6cd74bfb8d499781c542b6ebda6e5" CACHE INTERNAL "Micromamba SHA256")
set(MICROMAMBA_0.23.0_OSXARM64_SHA256 "d41de3796bea111e3eaa4e8904c4352003b5eaa7d61d97dc21bf917c70e35fd4" CACHE INTERNAL "Micromamba SHA256")
set(MICROMAMBA_0.23.0_PPC64LE_SHA256 "2836d468c7ec96022043eda01d7f037ca23b4e0b29c4f68c9078be95acb857f2" CACHE INTERNAL "Micromamba SHA256")
set(MICROMAMBA_0.23.0_AARCH64_SHA256 "d00828e00f4160103488b60c8a9378f23df62953e3d2647669bfc2ee9e6c6e13" CACHE INTERNAL "Micromamba SHA256")
set(MICROMAMBA_0.23.0_LINUX64_SHA256 "20f7049bd07087e0327c98bf4bde3243bb011a7d3be3ed4c18acb99152e246ab" CACHE INTERNAL "Micromamba SHA256")

# Construct the URL micromamba binary
function(mamba_get_url URL SHA256)
  cmake_parse_arguments(MICROMAMBA "" "VERSION" "" "${ARGN}")

  if(NOT DEFINED MICROMAMBA_VERSION OR MICROMAMBA_VERSION STREQUAL "")
    set(MICROMAMBA_VERSION ${MICROMAMBA_LATEST_VERSION})
  endif()

  set(MICROMAMBA_URL "https://anaconda.org/conda-forge/micromamba/${MICROMAMBA_VERSION}/download")
  set(MICROMAMBA_FILE "micromamba-${MICROMAMBA_VERSION}-0.tar.bz2")

  if(${CMAKE_HOST_SYSTEM_NAME} MATCHES "Darwin")
    if(${CMAKE_HOST_SYSTEM_PROCESSOR} MATCHES "arm")
      set(MICROMAMBA_URL "${MICROMAMBA_URL}/osx-arm64/${MICROMAMBA_FILE}")
      set(MICROMAMBA_SHA256 "${MICROMAMBA_${MICROMAMBA_VERSION}_OSXARM64_SHA256}")
    else()
      set(MICROMAMBA_URL "${MICROMAMBA_URL}/osx-64/${MICROMAMBA_FILE}")
      set(MICROMAMBA_SHA256 "${MICROMAMBA_${MICROMAMBA_VERSION}_OSX64_SHA256}")
    endif()
  elseif(${CMAKE_HOST_SYSTEM_NAME} MATCHES "Windows")
    set(MICROMAMBA_URL "${MICROMAMBA_URL}/win-64/${MICROMAMBA_FILE}")
    set(MICROMAMBA_SHA256 "${MICROMAMBA_${MICROMAMBA_VERSION}_WIN64_SHA256}")
  elseif(${CMAKE_HOST_SYSTEM_NAME} MATCHES "Linux")
    if(${CMAKE_HOST_SYSTEM_PROCESSOR} MATCHES "aarch64")
      set(MICROMAMBA_URL "${MICROMAMBA_URL}/linux-aarch64/${MICROMAMBA_FILE}")
      set(MICROMAMBA_SHA256 "${MICROMAMBA_${MICROMAMBA_VERSION}_AARCH64_SHA256}")
    elseif(${CMAKE_HOST_SYSTEM_PROCESSOR} MATCHES "ppc64le")
      set(MICROMAMBA_URL "${MICROMAMBA_URL}/linux-ppc64le/${MICROMAMBA_FILE}")
      set(MICROMAMBA_SHA256 "${MICROMAMBA_${MICROMAMBA_VERSION}_PPC64LE_SHA256}")
    elseif(${CMAKE_HOST_SYSTEM_PROCESSOR} MATCHES "64")
      set(MICROMAMBA_URL "${MICROMAMBA_URL}/linux-64/${MICROMAMBA_FILE}")
      set(MICROMAMBA_SHA256 "${MICROMAMBA_${MICROMAMBA_VERSION}_LINUX64_SHA256}")
    endif()
  else()
    message(FATAL_ERROR "Micromamba is not available for your system \"${CMAKE_HOST_SYSTEM_NAME}\"")
  endif()
  set(URL "${MICROMAMBA_URL}" PARENT_SCOPE)
  set(SHA256 "${MICROMAMBA_SHA256}" PARENT_SCOPE)
  set(VERSION "${MICROMAMBA_VERSION}" PARENT_SCOPE)
endfunction()

# Download the micromamba binary
function(download_micromamba)
  cmake_parse_arguments(MICROMAMBA "SHOW_PROGRESS" "DESTINATION;VERSION;TIMEOUT;INACTIVITY_TIMEOUT" "" "${ARGN}")

  if(NOT DEFINED MICROMAMBA_DESTINATION OR DESTINATION STREQUAL "")
    set(MICROMAMBA_DESTINATION "${CMAKE_BINARY_DIR}/micromamba")
  endif()
  mamba_get_url(URL SHA256 VERSION ${MICROMAMBA_VERSION})

  file(DOWNLOAD "${URL}" "${MICROMAMBA_DESTINATION}/micromamba-${VERSION}.tar.bz2"
      LOG FILE_LOG
      STATUS FILE_STATUS
      EXPECTED_HASH SHA256=${SHA256})

  execute_process(COMMAND "${CMAKE_COMMAND}" -E tar "xzf" "${MICROMAMBA_DESTINATION}/micromamba-${VERSION}.tar.bz2"
                  WORKING_DIRECTORY "${MICROMAMBA_DESTINATION}")

  set(DESTINATION "${MICROMAMBA_DESTINATION}" PARENT_SCOPE)
endfunction()

# Call the micromamba download
function(micromamba)
  cmake_parse_arguments(MICROMAMBA "SHOW_PROGRESS" "DESTINATION;VERSION" "" "${ARGN}")

  set(CMAKE_MODULE_PATH "${Micromamba_DIR}")

  if(NOT DEFINED MICROMAMBA_DESTINATION OR DESTINATION STREQUAL "")
    set(MICROMAMBA_DESTINATION "${CMAKE_BINARY_DIR}/micromamba")
  endif()

  if(CMMM_STANDALONE)
    download_micromamba(DESTINATION ${MICROMAMBA_DESTINATION} VERSION ${MICROMAMBA_VERSION})
    set(MICROMAMBA_ROOT ${DESTINATION})
    find_package(Micromamba REQUIRED)
  elseif(CMMM_LOCAL_ONLY)
    find_package(Micromamba REQUIRED)
  else()
    find_package(Micromamba QUIET)
    if(NOT Micromamba_FOUND)
      message(STATUS "Installing it to ${MICROMAMBA_DESTINATION}")
      download_micromamba(DESTINATION ${MICROMAMBA_DESTINATION} VERSION ${MICROMAMBA_VERSION})
      set(MICROMAMBA_ROOT ${DESTINATION})
      find_package(Micromamba REQUIRED)
    endif()
  endif()
endfunction()

# Setup micromamba environment
macro(micromamba_environment)
  message("Installing dependencies from channels:")

  cmake_parse_arguments(PARSED_ARGS "" "" "CHANNELS;DEPENDENCIES" ${ARGN})

  micromamba()

  set(CHANNEL_ARG "")
  foreach(Channel ${PARSED_ARGS_CHANNELS})
    list(APPEND CHANNEL_ARG "-c")
    list(APPEND CHANNEL_ARG ${Channel})
  endforeach()

  execute_process(COMMAND ${MICROMAMBA_EXECUTABLE} create -p "${CMAKE_BINARY_DIR}/environment" ${CHANNEL_ARG} ${PARSED_ARGS_DEPENDENCIES} --yes COMMAND_ECHO STDOUT)
  set(CMAKE_PREFIX_PATH "${CMAKE_BINARY_DIR}/environment;${CMAKE_PREFIX_PATH}")
endmacro()
